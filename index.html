<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="seah-logo.jpg">
    <title>세아씨엠 결로 방지 모니터링 시스템</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002d57">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Failed', err));
            });
        }
    </script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="main-header">
            <div class="header-left">
                <div class="brand-box">
                    <img src="seah-logo.jpg" alt="SeAH CM Logo" class="brand-logo">
                </div>
                <div class="header-v-divider"></div>
                <h1>결로 지수 모니터링 시스템</h1>
            </div>

            <div class="header-right">
                <nav class="header-nav">
                    <button id="nav-dashboard" class="btn-nav active" onclick="toggleView('dashboard')">대시보드</button>
                    <button id="nav-history" class="btn-nav" onclick="toggleView('history')">결로 이력</button>
                    <button id="nav-forecast" class="btn-nav" onclick="toggleView('forecast')">주간 예측 ↗</button>
                    <button id="admin-login-btn" class="btn-nav admin-hidden" onclick="openPwdModal()">관리자 로그인</button>
                    <div class="admin-badge admin-only">관리자 모드</div>
                    <button id="admin-logout-btn" class="btn-nav admin-only" onclick="logoutAdmin()">로그아웃</button>
                    <button id="setting-btn" class="btn-nav admin-only" onclick="openSettingModal()"
                        style="padding: 5px 10px;">⚙️</button>
                </nav>
                <div id="current-time">2024-01-07 13:00</div>
            </div>
        </header>

        <!-- ... -->

    </div>

    <!-- Setting Modal -->
    <div id="setting-modal" class="modal">
        <div class="modal-content setting-modal-content">
            <div class="modal-header">
                <h2>환경 설정</h2>
                <span class="close-btn" onclick="closeSettingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="setting-group" style="text-align: center; padding: 20px 0;">
                    <p>기상청 API 키 및 주요 시스템 설정은 <br><strong>Firebase 콘솔</strong>에서 직접 관리됩니다.</p>
                    <small class="text-muted">보안을 위해 앱 내 수정 기능을 비활성화하였습니다.</small>
                </div>
                <div class="setting-actions">
                    <button class="btn-primary" onclick="closeSettingModal()">확인</button>
                </div>
            </div>
        </div>
    </div>


    <div id="dashboard-view" class="view-content active">
        <section class="dashboard-grid">
            <!-- 상단 정보 영역 (위험도 + 날씨) -->
            <div class="risk-weather-area">
                <!-- 현재 결로 위험도 -->
                <div class="card status-card" id="risk-indicator">
                    <h3>현재 결로 위험도</h3>
                    <div style="display: flex; align-items: center; justify-content: space-around; width: 100%;">
                        <div style="text-align: center; flex: 1;">
                            <div class="status-value" id="status-text">데이터 부족</div>
                            <p id="risk-reason-text" class="status-reason"
                                style="margin-top: 2px; font-size: 0.8rem; opacity: 0.9;">분석 대기 중</p>
                        </div>
                        <div style="width: 1px; height: 50px; background: rgba(255,255,255,0.2); margin: 0 8px;"></div>
                        <div class="metrics-row" style="display: flex; gap: 10px; flex: 1; justify-content: center;">
                            <div class="metric-box" style="text-align: center;">
                                <span
                                    style="font-size: 0.8em; color: #ddd; display: block; margin-bottom: 2px;">이슬점</span>
                                <strong id="dew-point-val" style="font-size: 1.25em; color: white;">--</strong>
                            </div>
                            <div class="metric-box" style="text-align: center;">
                                <span
                                    style="font-size: 0.8em; color: #ddd; display: block; margin-bottom: 2px;">온도차</span>
                                <strong id="temp-diff-val" style="font-size: 1.25em; color: white;">--</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 날씨정보 -->
                <div class="card weather-card">
                    <h3>날씨정보</h3>
                    <div class="weather-horizontal-wrap" style="justify-content: space-around; width: 100%;">
                        <div style="display: flex; align-items: center; justify-content: center; flex: 1; gap: 15px;">
                            <div class="weather-main">
                                <div class="weather-value" id="outdoor-temp">--°C</div>
                                <div class="weather-sub-value" id="outdoor-humidity">습도: --%</div>
                                <p class="weather-loc">군산 세아씨엠</p>
                            </div>
                            <div id="weather-icon-container" class="weather-icon-display"></div>
                        </div>
                        <div style="width: 1px; height: 50px; background: rgba(0,0,0,0.1); margin: 0 8px;"></div>
                        <div class="weather-forecast-grid" style="flex: 1; justify-content: center;">
                            <div class="forecast-item">
                                <span class="f-label">오전</span>
                                <div class="f-data"><span class="f-sub-label">강수:</span><strong
                                        id="weather-am-rain">--</strong></div>
                                <div class="f-data"><span class="f-sub-label">확률:</span><span class="f-prob"
                                        id="weather-am-prob">--%</span></div>
                            </div>
                            <div class="forecast-item">
                                <span class="f-label">오후</span>
                                <div class="f-data"><span class="f-sub-label">강수:</span><strong
                                        id="weather-pm-rain">--</strong></div>
                                <div class="f-data"><span class="f-sub-label">확률:</span><span class="f-prob"
                                        id="weather-pm-prob">--%</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 정기 점검 현황 -->
            <div class="card report-status-card" style="grid-area: report;">
                <div class="report-status-header">
                    <h3>정기 점검 현황</h3>
                    <input type="date" id="status-inspection-date" class="status-date-input">
                </div>
                <div class="report-slots">
                    <div class="report-slot" id="slot-0700">
                        <span class="slot-time">07:00</span>
                        <span class="slot-status">미등록</span>
                        <div class="slot-actions">
                            <button id="edit-btn-0700" class="btn-mini btn-primary-mini">기록</button>
                            <button id="view-btn-0700" class="btn-mini btn-secondary-mini" disabled>조회</button>
                        </div>
                    </div>
                    <div class="report-slot" id="slot-1500">
                        <span class="slot-time">15:00</span>
                        <span class="slot-status">미등록</span>
                        <div class="slot-actions">
                            <button id="edit-btn-1500" class="btn-mini btn-primary-mini">기록</button>
                            <button id="view-btn-1500" class="btn-mini btn-secondary-mini" disabled>조회</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 위치별 최신 현황 -->
            <div class="card location-summary-card" style="grid-area: main;">
                <div class="location-summary-header">
                    <div class="header-title">
                        <h3>위치별 최신 현황 <span id="location-sync-time"
                                style="font-size: 0.85rem; font-weight: normal; color: #666; margin-left: 8px;"></span>
                        </h3>
                    </div>
                    <div class="header-inputs admin-only">
                        <div class="input-row-mini">
                            <input type="date" id="report-date" class="mini-input-field">
                            <select id="report-time" class="mini-input-field">
                                <option value="07:00">07:00</option>
                                <option value="15:00">15:00</option>
                                <option value="실시간">실시간</option>
                            </select>
                            <div class="mini-input-wrap">
                                <span class="mini-label">외온:</span>
                                <input type="number" id="outdoor-temp-input" step="0.1"
                                    class="mini-input-field weather-sync" style="width: 75px;">
                            </div>
                            <div class="mini-input-wrap">
                                <span class="mini-label">외습:</span>
                                <input type="number" id="outdoor-humidity-input" step="1"
                                    class="mini-input-field weather-sync" style="width: 70px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="location-status-list" class="status-list"></div>
            </div>

            <!-- 점검 기록 히스토리 -->
            <div class="card history-card" style="grid-area: history;">
                <div class="card-header-column">
                    <h3>점검 기록 히스토리</h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 0;">📅 날짜를 클릭하여 상세 이력을 조회하세요.</p>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)" class="btn-cal-nav">&lt;</button>
                        <span id="calendar-month-year">2024년 1월</span>
                        <button onclick="changeMonth(1)" class="btn-cal-nav">&gt;</button>
                    </div>
                </div>
                <div id="calendar-container" class="calendar-container">
                    <!-- JS에서 동적 생성 -->
                </div>
            </div>
        </section>

        <!-- 로그 테이블 -->
        <div class="log-section">
            <div class="card">
                <div class="log-header">
                    <h3>모니터링 로그 (최근 5건)</h3>
                    <div class="header-btns">
                        <button id="view-all-logs-btn" class="btn-mini" onclick="viewAllLogs()">전체보기</button>
                        <button id="clear-log-btn" class="btn-mini btn-danger admin-only">기록 삭제</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>일시</th>
                                <th>위치</th>
                                <th>외온</th>
                                <th>외습</th>
                                <th>내온</th>
                                <th>내습</th>
                                <th>이슬점</th>
                                <th>소재</th>
                                <th>온도차</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody id="log-body">
                            <!-- Logs populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NEW: Full Log History Modal -->
        <div id="log-modal" class="modal">
            <div class="modal-content full-modal">
                <div class="modal-header">
                    <h2 id="log-modal-title">전체 모니터링 로그 분석</h2>
                    <span class="close-btn" onclick="closeLogModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>일시</th>
                                    <th>위치</th>
                                    <th>외온</th>
                                    <th>외습</th>
                                    <th>내온</th>
                                    <th>내습</th>
                                    <th>이슬점</th>
                                    <th>소재</th>
                                    <th>온도차</th>
                                    <th>상태</th>
                                </tr>
                            </thead>
                            <tbody id="full-log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Details Modal -->
        <div id="report-modal" class="modal">
            <div class="modal-content full-modal">
                <div class="modal-header">
                    <h2 id="modal-title">점검 상세 기록</h2>
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>위치</th>
                                    <th>시간</th>
                                    <th>외온</th>
                                    <th>외습</th>
                                    <th>내온</th>
                                    <th>내습</th>
                                    <th>이슬점</th>
                                    <th>소재</th>
                                    <th>온도차</th>
                                    <th>GATE</th>
                                    <th>포장</th>
                                    <th>제품상태</th>
                                    <th>위험도</th>
                                </tr>
                            </thead>
                            <tbody id="modal-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="pwd-modal" class="pwd-modal">
        <div class="pwd-modal-content">
            <h3>관리자 인증</h3>
            <p>관리자 암호를 입력해주세요.</p>
            <input type="tel" id="admin-pwd-input" class="pwd-input" placeholder="****" inputmode="numeric"
                pattern="[0-9]*" maxlength="4" autocomplete="one-time-code">
            <div class="pwd-btns">
                <button class="btn-cancel" onclick="closePwdModal()">취소</button>
                <button class="btn-login" onclick="loginAdmin()">확인</button>
            </div>
        </div>
    </div>

    <div id="forecast-view" class="view-content">
        <section class="forecast-container">
            <div class="forecast-header">
                <div>
                    <h2>차주 결로 발생 예측 (7일 예보)</h2>
                    <p class="text-muted">기상청 단기/중기 예보 및 군산 세아씨엠 지역 데이터를 기반으로 한 예측입니다.</p>
                </div>
                <button onclick="refreshWeeklyForecast()" class="btn-refresh" title="최신 데이터 새로고침">
                    🔄 새로고침
                </button>
            </div>

            <div class="forecast-summary-card card mt-md">
                <div class="summary-icon">💡</div>
                <div class="summary-text">
                    <h4>주간 관리 가이드</h4>
                    <p id="weekly-management-guide">데이터를 분석 중입니다...</p>
                </div>
            </div>

            <div id="weekly-forecast-grid" class="weekly-forecast-grid mt-lg">
                <!-- JS에서 7일간의 예측 카드를 생성합니다 -->
            </div>

            <!-- 당일 시간별 습도 예보 -->
            <div class="hourly-humidity-card card mt-lg">
                <div class="card-header-flex"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <h4>💧 시간별 습도 예보 <span id="hourly-update-time"></span></h4>
                    <input type="date" id="hourly-forecast-date" class="status-date-input" style="width: auto;">
                </div>
                <p class="text-muted" style="margin-bottom: 12px; font-size: 0.85rem;">기상청 단기예보 기준 (1시간 단위)</p>
                <div id="hourly-humidity-grid" class="hourly-humidity-grid">
                    <div class="hourly-loading">데이터를 불러오는 중...</div>
                </div>
            </div>

            <div class="equipment-guide-card card mt-lg">
                <h4>🛠️ 설비 가동 기준 안내</h4>
                <div class="guide-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="guide-item guide-heater">
                        <div class="guide-header">
                            <span class="guide-icon">🔥</span>
                            <strong>열풍기 (강판 예열)</strong>
                        </div>
                        <p class="guide-condition">전일대비 기온상승 <strong>8~10℃↑</strong><br>또는 습도 <strong>80%↑</strong></p>
                        <small>목적: 따뜻한 공기 유입 전 강판 온도 선제적 상승</small>
                    </div>
                    <div class="guide-item guide-fan">
                        <div class="guide-header">
                            <span class="guide-icon">🌀</span>
                            <strong>배풍기 (습기 제거)</strong>
                        </div>
                        <p class="guide-condition">기온 상승폭 <strong>8℃ 이상</strong><br>또는 습도 <strong>80% 이상</strong></p>
                        <small>목적: 내부 정체 습기 제거 및 외부 공기 순환</small>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 결로 이력 뷰 -->
    <div id="history-view" class="view-content">
        <section class="card full-width">
            <div class="forecast-header">
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>🚨 결로 발생 분석 및 이력</h2>
                        <button onclick="openPastRecordModal()" class="btn-nav admin-only"
                            style="background: var(--seah-orange); color: white;">➕ 과거 이력 등록</button>
                    </div>
                    <p class="text-muted">축적된 과거 결로 발생 데이터를 토대로 주간 예보의 정확도를 높입니다.</p>
                </div>

                <!-- 결로 분석 상단 카드 -->
                <div class="analysis-stats-container mt-md">
                    <div class="stat-card stat-blue">
                        <span class="stat-label">총 발생 횟수</span>
                        <strong id="stat-total-count" class="stat-value-mini">0 건</strong>
                        <span class="stat-sub-label">기준: 수동 등록 및 점검 결과 합계</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">주요 발생 외기온도</span>
                        <strong id="stat-avg-outdoor-temp" class="stat-value-mini">- °C</strong>
                        <span class="stat-sub-label">최빈 발생 구간 분석 결과</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">평균 발생 외기습도</span>
                        <strong id="stat-avg-outdoor-hum" class="stat-value-mini">- %</strong>
                        <span class="stat-sub-label">기상 예보 연동 시 주요 선행 지표</span>
                    </div>
                    <div class="stat-card stat-red">
                        <span class="stat-label">평균 온도차 (소재-이슬점)</span>
                        <strong id="stat-avg-diff" class="stat-value-mini">- °C</strong>
                        <span class="stat-sub-label">발생 시 평균 이슬점 근접도</span>
                    </div>
                </div>
                <div class="table-container mt-md">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>발생일시</th>
                                <th>위치</th>
                                <th title="외기온도">외온</th>
                                <th title="외기습도">외습</th>
                                <th title="실내온도">내온</th>
                                <th title="실내습도">내습</th>
                                <th>이슬점</th>
                                <th title="소재온도">소재</th>
                                <th>온도차</th>
                                <th>발생원인</th>
                                <th class="admin-only">관리</th>
                            </tr>
                        </thead>
                        <tbody id="history-log-body">
                            <!-- JS Inject -->
                        </tbody>
                    </table>
                </div>
                <div id="history-pagination" class="pagination-container mt-md"></div>
                <div id="history-message" class="text-center mt-md text-muted">데이터를 조회 중입니다...</div>
        </section>
    </div>
    </div>

    <!-- Past Record Modal -->
    <div id="past-record-modal" class="modal">
        <div class="modal-content setting-modal-content">
            <div class="modal-header">
                <h2>과거 결로 기록 등록</h2>
                <span class="close-btn" onclick="closePastRecordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="text-muted text-center mb-md">과거에 발생한 결로 데이터를 등록하여<br>예측 정확도를 높입니다.</p>
                <div class="input-group">
                    <label>발생 일시</label>
                    <input type="datetime-local" id="past-date" class="input-field">
                </div>
                <div class="input-group">
                    <label>위치</label>
                    <select id="past-location" class="input-field">
                        <!-- JS로 채움 -->
                    </select>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>당시 외기온도 (℃)</label>
                        <input type="number" id="past-outdoor" class="input-field" step="0.1" placeholder="예: -2.5">
                    </div>
                    <div class="input-group">
                        <label>당시 외기습도 (%)</label>
                        <input type="number" id="past-outdoor-humid" class="input-field" step="1" placeholder="예: 85">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>강판온도 (℃)</label>
                        <input type="number" id="past-steel" class="input-field" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>실내온도 (℃)</label>
                        <input type="number" id="past-indoor" class="input-field" step="0.1">
                    </div>
                </div>
                <div class="input-group">
                    <label>실내습도 (%)</label>
                    <input type="number" id="past-humid" class="input-field" step="1">
                </div>
                <input type="hidden" id="past-record-id">
                <div class="setting-actions">
                    <button class="btn-secondary" onclick="closePastRecordModal()">취소</button>
                    <button id="past-record-submit-btn" class="btn-primary" onclick="savePastRecord()">등록하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (호환 버전) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <script>
        // Firebase 설정 (사용자 프로젝트: seahcm-dashboard)
        const firebaseConfig = {
            apiKey: "AIzaSyAt26JyW_MNzj033K3BPX4pPRGUAUH2occ",
            authDomain: "seahcm-dashboard.firebaseapp.com",
            databaseURL: "https://seahcm-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "seahcm-dashboard",
            storageBucket: "seahcm-dashboard.firebasestorage.app",
            messagingSenderId: "892539664890",
            appId: "1:892539664890:web:0a0a9275615175ba504c43",
            measurementId: "G-Y1CQHT81G9"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>

    <!-- 앱 로직 실행 -->
    <script src="app.js"></script>
</body>

</html>